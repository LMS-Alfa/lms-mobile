-- USERS TABLE
CREATE TABLE public.users (
  id uuid NOT NULL,
  email TEXT NOT NULL,
  "firstName" TEXT NOT NULL,
  "lastName" TEXT NOT NULL,
  password TEXT NOT NULL,
  role CHARACTER VARYING NOT NULL,
  status TEXT NOT NULL DEFAULT 'active',
  "lastLogin" TIMESTAMPTZ NULL,
  "createdAt" TIMESTAMPTZ NOT NULL DEFAULT now(),
  is_role_manager BOOLEAN NULL DEFAULT FALSE,
  role_id UUID NULL,
  is_module_leader BOOLEAN NULL,
  parent_id UUID NULL,
  "fullName" TEXT GENERATED ALWAYS AS ((("firstName" || ' ') || "lastName")) STORED,
  expo_push_token TEXT NULL,
  CONSTRAINT users_pkey PRIMARY KEY (id),
  CONSTRAINT unique_user_email UNIQUE (email),
  CONSTRAINT users_id_fkey FOREIGN KEY (id) REFERENCES auth.users (id) ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT users_parent_id_fkey FOREIGN KEY (parent_id) REFERENCES users (id) ON DELETE SET NULL,
  CONSTRAINT users_role_fkey FOREIGN KEY (role) REFERENCES roles (name) ON UPDATE CASCADE,
  CONSTRAINT users_role_id_fkey FOREIGN KEY (role_id) REFERENCES roles (id) ON DELETE SET NULL
);

-- SCORES TABLE
CREATE TABLE public.scores (
  id UUID NOT NULL DEFAULT gen_random_uuid(),
  student_id UUID NOT NULL,
  lesson_id UUID NOT NULL,
  quarter_id UUID NOT NULL,
  teacher_id UUID NULL,
  score NUMERIC NOT NULL,
  created_at TIMESTAMPTZ NOT NULL,
  comment TEXT NULL,
  updated_at TIMESTAMPTZ NULL,
  CONSTRAINT scores_pkey PRIMARY KEY (id),
  CONSTRAINT unique_score_per_student_lesson_quarter UNIQUE (student_id, lesson_id, quarter_id),
  CONSTRAINT scores_lesson_id_fkey FOREIGN KEY (lesson_id) REFERENCES lessons (id) ON DELETE CASCADE,
  CONSTRAINT scores_quarter_id_fkey FOREIGN KEY (quarter_id) REFERENCES quarters (id) ON DELETE RESTRICT,
  CONSTRAINT scores_student_id_fkey FOREIGN KEY (student_id) REFERENCES users (id) ON DELETE CASCADE,
  CONSTRAINT scores_teacher_id_fkey FOREIGN KEY (teacher_id) REFERENCES users (id) ON DELETE SET NULL
);

-- ANNOUNCEMENTS TABLE
CREATE TABLE public.announcements (
  id BIGINT GENERATED BY DEFAULT AS IDENTITY NOT NULL,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  title TEXT NULL,
  content TEXT NULL,
  "targetAudience" CHARACTER VARYING NULL,
  "isImportant" BOOLEAN NULL,
  video_url TEXT NULL,
  photo_url TEXT NULL,
  created_by UUID NULL DEFAULT gen_random_uuid(),
  created_by_name TEXT NULL,
  video_name TEXT NULL,
  photo_name TEXT NULL,
  CONSTRAINT announcements_pkey PRIMARY KEY (id),
  CONSTRAINT announcements_photo_name_key UNIQUE (photo_name),
  CONSTRAINT announcements_video_name_key UNIQUE (video_name),
  CONSTRAINT announcements_created_by_fkey FOREIGN KEY (created_by) REFERENCES users (id) ON UPDATE CASCADE ON DELETE CASCADE
);

-- ATTENDANCE TABLE
CREATE TABLE public.attendance (
  id UUID NOT NULL DEFAULT extensions.uuid_generate_v4(),
  lesson_id UUID NOT NULL,
  student_id UUID NOT NULL,
  noted_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  status public.attendance_status NULL,
  quarter_id UUID NULL,
  CONSTRAINT attendance_pkey PRIMARY KEY (id),
  CONSTRAINT attendance_lesson_id_student_id_key UNIQUE (lesson_id, student_id),
  CONSTRAINT attendance_lesson_id_fkey FOREIGN KEY (lesson_id) REFERENCES lessons (id) ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT attendance_quarter_id_fkey FOREIGN KEY (quarter_id) REFERENCES quarters (id) ON UPDATE CASCADE ON DELETE CASCADE,
  CONSTRAINT attendance_student_id_fkey FOREIGN KEY (student_id) REFERENCES users (id) ON DELETE CASCADE
);

CREATE INDEX IF NOT EXISTS idx_attendance_lesson ON public.attendance USING btree (lesson_id);
CREATE INDEX IF NOT EXISTS idx_attendance_student ON public.attendance USING btree (student_id);
üìä Table Relationships and Descriptions
üîπ users
Core user data (students, teachers, admins).

Related to:

auth.users (auth system)

Itself via parent_id (e.g., teacher‚Äìstudent or mentor‚Äìmentee)

roles via both role (name) and role_id (UUID)

Key columns:

id: UUID primary key, must match auth.users

role / role_id: permission control

parent_id: another user, like a mentor or supervisor

expo_push_token: for push notifications

fullName: virtual field (generated from first and last name)

üîπ scores
Each row represents a student's score for a specific lesson and quarter.

Related to:

users as student_id (required)

users as teacher_id (optional)

lessons, quarters

Key constraints:

Unique combination of student_id, lesson_id, quarter_id ‚Äî no duplicate scores for the same session.

üîπ announcements
System-wide or targeted messages.

Related to:

users as created_by

Can include:

Video and image links

Title, content, flags (e.g., isImportant)

Unique constraints:

Each photo_name and video_name must be unique.

üîπ attendance
Marks presence for a student_id in a lesson_id, with optional quarter_id.

Related to:

users as students

lessons, quarters

Specials:

status is an enum (present, absent, late, excused)

noted_at is the timestamp when the note was made

Unique per student_id and lesson_id to avoid duplicates

‚ö†Ô∏è Instructions to Cursor
üß† NOTE TO CURSOR:

Only interact with the tables defined above: users, scores, announcements, attendance.

Do NOT reference or make assumptions about tables that were not explicitly defined or shown.

If a referenced table like lessons or quarters is needed, ask for its schema explicitly first.

Do not infer behavior or create new logic unless it's stated clearly in the prompt.